<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Issue Management</title>
    <style>
        .draggable {
            cursor: move;
        }
    </style>
</head>
<body>
    <h2>新建 Issue</h2>
    
    <div class="name">
        <p>Issue 名称:</p>
        <input id="name">
    </div>

    <div class="addProblems">
        <h2>添加题目</h2>
        <form id="addProblemById">
            <label for="problemId">用ID添加（多个题目用半角逗号分隔）：</label>
            <input type="text" id="problemId" name="problemId" required>
            <button type="submit">添加</button>
        </form>
        <form id="addProblemBySearching">
            <label for="query">搜索题目</label>
            <input type="text" id="query" name="query" required><br>
            <button type="submit">搜索</button>
        </form>
        <ul id="searchResults"></ul>
    </div>

    <h2>当前 Issue 中的题目</h2>
    <ul id="issueProblems" class="sortable"></ul>

    <button id="saveIssue">保存</button>

    <script>
        var issueId=-1;
        let problems = [];

        document.getElementById('addProblemById').addEventListener('submit', async function (event) {
            event.preventDefault();
            console.log('add problem by id');
            const formData = new FormData(this);
            const data = Object.fromEntries(formData);
            console.log(data.problemId);
            var problemId = data.problemId.split(',').map(id => parseInt(id.trim())).filter(id => !isNaN(id));
            console.log(problemId);
            problems=problems.concat(problemId);
            loadIssueProblems();
        });

        document.getElementById('addProblemBySearching').addEventListener('submit', async function (event) {
            event.preventDefault();
            const formData = new FormData(this);
            const data = Object.fromEntries(formData);
            const response = await fetch(`/searchProblems?query=${data.query}`);
            const problems = await response.json();
            const searchResults = document.getElementById('searchResults');
            searchResults.innerHTML = '';
            problems.forEach(problem => {
                const listItem = document.createElement('li');
                listItem.textContent = `ID: ${problem.id}, Name: ${problem.name}`;
                const addButton = document.createElement('button');
                addButton.textContent = '添加';
                addButton.addEventListener('click', () => addProblemToIssue(problem.id));
                listItem.appendChild(addButton);
                searchResults.appendChild(listItem);
            });
        });

        async function addProblemToIssue(problemId) {
            problems.push(problemId);
            loadIssueProblems();
        }

        async function loadIssueProblems() {
            const issueProblems = document.getElementById('issueProblems');
            issueProblems.innerHTML = '';
            for (let i = 0; i < problems.length; i++) {
                const problemId = problems[i];
                const listItem = document.createElement('li');
                listItem.classList.add('draggable');
                await fetch('/problems?id=' + problemId)
                    .then(response => response.json())
                    .then(problem => {
                        problem = problem[0];
                        listItem.textContent = `ID: ${problem.id}, Name: ${problem.name}`;
                        const removeButton = document.createElement('button');
                        removeButton.textContent = '×';
                        // 使用闭包捕获当前的 index 值
                        (function(index) {
                            removeButton.addEventListener('click', () => removeProblemFromIssue(index));
                        })(i);
                        listItem.appendChild(removeButton);
                        issueProblems.appendChild(listItem);
                    });
            }
        }

        async function removeProblemFromIssue(index) {
            console.log(index);
            problems.splice(index, 1);
            loadIssueProblems();
        }

        document.getElementById('saveIssue').addEventListener('click', async function () {
            if(issueId!==-1) {
                const response=await fetch('/saveIssue', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ issueId: issueId, problemIds: problems })
                });
                const result = await response.json();
                alert(result.message || result.error);
            }
            else{
                const response=await fetch('/newissue', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name: document.getElementById('name').value, problemIds: problems })
                });
                const result = await response.json();
                if(response.ok) issueId=result.issueId;
                alert(result.message || result.error);
            }
        });

        // 初始化拖拽排序功能
        new Sortable(document.getElementById('issueProblems'), {
            animation: 150,
            ghostClass: 'sortable-ghost'
        });
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.14.0/Sortable.min.js"></script>
</body>
</html>